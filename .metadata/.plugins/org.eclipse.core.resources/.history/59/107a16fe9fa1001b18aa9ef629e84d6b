(()=>{
	const timeInBtn = $("#time-in-btn");
	const timeOutBtn = $("#time-out-btn");
	const dateInInput = $("[name=date_in]");
	const dateOutInput = $("[name=date_out]");
	const getUser = ()=>JSON.parse(localStorage['user']);
	const updateDateToday = ()=>{
		$("#date-today").text(moment().format("LLL"));
	}
	const setLatestRecord = ()=>{
		const records = getUser().records.sort((a,b)=>new Date(b.date_in) - new Date(a.date_in));
		const dateNow = moment().format("LL");
		const lastRecordDate = moment(records[0].date_in).format("LL");
		const isCurrentDate = lastRecordDate === dateNow;
		
		if(isCurrentDate && records[0].date_out === ""){
			timeOutBtn.addClass("current");
			dateInInput.val(moment(records[0].date_in).format("hh:mm A"));
			timeInBtn.prop("disabled",true);
		} else if(records[0].date_in === ""){
			timeInBtn.addClass("current");
			timeOutBtn.prop("disabled",true);
		} else if(isCurrentDate && records[0].date_in !== "" && records[0].date_out !== ""){
			dateInInput.val(moment(records[0].date_in).format("hh:mm A"));
			dateOutInput.val(moment(records[0].date_out).format("hh:mm A"));
			timeOutBtn.prop("disabled",true);
			timeInBtn.prop("disabled",true);
		} else {
			timeInBtn.addClass("current");
			timeOutBtn.prop("disabled",true);
		}

	}
	window.timeTicker = setInterval(()=>{
		updateDateToday();
	},60000);
	const printDTRRecords = ()=>{
		getUser().records.sort((a,b)=>new Date(b.date_in) - new Date(a.date_in)).map(record=>{
			const date = moment(record.date_in).format("LL");
			const timeIn = moment(record.date_in).format("hh:mm A");
			const timeOut = moment(record.date_out).format("hh:mm A");
			const timeSpan = timeIn+" - "+(timeOut == "Invalid date"? "<i>pending</i>":timeOut);
			let duration = moment.duration(moment(record.date_out).diff(moment(record.date_in))).asHours();
			if(isNaN(duration)){
				duration = "To be defined";
			} else {
				duration = `${duration.toFixed(2)} hours`;
			}
			
			$("#dtr-body").append(`
					<tr>
						<td>${date}</td>
						<td>${timeSpan}</td>
						<td>${duration}</td>
					</tr>
			
			`);
		});
	}
	const init = ()=>{
		updateDateToday();
		printDTRRecords();
		setLatestRecord();
		$("[name=employeeID]").val(getUser().employeeID);
	}
	
	init();
})();