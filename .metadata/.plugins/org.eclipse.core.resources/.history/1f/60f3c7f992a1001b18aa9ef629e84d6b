package com.intprog.dao;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.HashMap;

import com.intprog.model.DTRModel;
import com.intprog.model.Employee;

public class EmployeeDAO {
	  private static final String url = "jdbc:mysql://localhost:3306/sales_database?useSSL=false&useUnicode=true&useJDBCCompliantTimezoneShift=true&useLegacyDatetimeCode=false&serverTimezone=UTC";
	  private static final String user = "root";
	  private static final String password = "";
    
	  public ArrayList<Employee> allEmployee() throws ClassNotFoundException {
		String INSERT_USERS_SQL = "SELECT * FROM employee_table";
		ArrayList<Employee> employees = new ArrayList<Employee>();
        Class.forName("com.mysql.cj.jdbc.Driver");

        try (Connection connection = DriverManager
            .getConnection(url,user,password);

            // Step 2:Create a statement using connection object
            PreparedStatement preparedStatement = connection.prepareStatement(INSERT_USERS_SQL)) {

            System.out.println(preparedStatement);
            // Step 3: Execute the query or update query
            ResultSet result = preparedStatement.executeQuery();
            
            while(result.next()) {
              	Employee employee = new Employee();
              	employee.setEmployeeID(result.getInt("employeeID"));
            	employee.setFirstname(result.getString("firstname"));
            	employee.setLastname(result.getString("lastname"));
            	employee.setMi(result.getString("mi"));
            	employee.setEmail(result.getString("email"));
            	employee.setUsername(result.getString("username"));
            	employee.setPassword(result.getString("password"));
            	employees.add(employee);
            }

        } catch (SQLException e) {
            printSQLException(e);
        }
		  return employees;
	  }
	  
	  public Employee registerEmployee(Employee employee) throws ClassNotFoundException {
	        String INSERT_USERS_SQL = "INSERT INTO employee_table" +
	            "  (email, firstname, lastname, username, password, mi) VALUES " +
	            " (?, ?, ?, ?, ?, ?);";

	        int result = 0;

	        Class.forName("com.mysql.cj.jdbc.Driver");

	        try (Connection connection = DriverManager
	            .getConnection(url,user,password);

	            // Step 2:Create a statement using connection object
	            PreparedStatement preparedStatement = connection.prepareStatement(INSERT_USERS_SQL)) {
	            preparedStatement.setString(1, employee.getEmail());
	            preparedStatement.setString(2, employee.getFirstname());
	            preparedStatement.setString(3, employee.getLastname());
	            preparedStatement.setString(4, employee.getUsername());
	            preparedStatement.setString(5, employee.getPassword());
	            preparedStatement.setString(6, employee.getMi());

	            System.out.println(preparedStatement);
	            // Step 3: Execute the query or update query
	            result = preparedStatement.executeUpdate();

	        } catch (SQLException e) {
	            // process sql exception
	            printSQLException(e);
	        }
	        
	        try (Connection connection = DriverManager
		            .getConnection(url,user,password);

		            // Step 2:Create a statement using connection object
		            PreparedStatement preparedStatement = connection.prepareStatement("SELECT * FROM employee_table ORDER by employeeID DESC LIMIT 1")) {

		            System.out.println(preparedStatement);
		            // Step 3: Execute the query or update query
		            ResultSet res = preparedStatement.executeQuery();
		            
		            while(res.next()) {
		            	employee.setEmployeeID(res.getInt("employeeID"));
		            	employee.setFirstname(res.getString("firstname"));
		            	employee.setLastname(res.getString("lastname"));
		            	employee.setMi(res.getString("mi"));
		            	employee.setEmail(res.getString("email"));
		            	employee.setUsername(res.getString("username"));
		            	employee.setPassword(res.getString("password"));
		            }
		        } catch (SQLException e) {
		            printSQLException(e);
		        }
	        
		   return employee;
	    }
	  
	  public Employee selectEmployee(int id) throws ClassNotFoundException {
	        String INSERT_USERS_SQL = "SELECT * FROM employee_table WHERE employeeID = "+id;
        	Employee employee = new Employee();

	        Class.forName("com.mysql.cj.jdbc.Driver");

	        try (Connection connection = DriverManager
	            .getConnection(url,user,password);

	            // Step 2:Create a statement using connection object
	            PreparedStatement preparedStatement = connection.prepareStatement(INSERT_USERS_SQL)) {

	            System.out.println(preparedStatement);
	            // Step 3: Execute the query or update query
	            ResultSet result = preparedStatement.executeQuery();
	            
	            while(result.next()) {
	            	employee.setEmployeeID(result.getInt("employeeID"));
	            	employee.setFirstname(result.getString("firstname"));
	            	employee.setLastname(result.getString("lastname"));
	            	employee.setMi(result.getString("mi"));
	            	employee.setEmail(result.getString("email"));
	            	employee.setUsername(result.getString("username"));
	            	employee.setPassword(result.getString("password"));
	            }

	        } catch (SQLException e) {
	            printSQLException(e);
	        }
	        return employee;
	    }
	  
	  public Employee updateEmployee(Employee employee) throws ClassNotFoundException {
		String UPDATE_SQL_TEMPLATE = "UPDATE employee_table SET firstname = '%s', lastname = '%s', mi = '%s', email = '%s', username = '%s',password = '%s' WHERE employeeID = %d";
	    String UPDATE_SQL = String.format(
	    						UPDATE_SQL_TEMPLATE, 
	    						employee.getFirstname(),
	    						employee.getLastname(),
	    						employee.getMi(),
	    						employee.getEmail(),
	    						employee.getUsername(),
	    						employee.getPassword(),
	    						employee.getEmployeeID()
    						);

	        Class.forName("com.mysql.cj.jdbc.Driver");

	        try (Connection connection = DriverManager
	            .getConnection(url,user,password);
	            PreparedStatement preparedStatement = connection.prepareStatement(UPDATE_SQL)) {
	            System.out.println(UPDATE_SQL);
	            preparedStatement.executeUpdate();
	        } catch (SQLException e) {
	            printSQLException(e);
	        }
	        return employee;
	    }


	    private void printSQLException(SQLException ex) {
	        for (Throwable e: ex) {
	            if (e instanceof SQLException) {
	                e.printStackTrace(System.err);
	                System.err.println("SQLState: " + ((SQLException) e).getSQLState());
	                System.err.println("Error Code: " + ((SQLException) e).getErrorCode());
	                System.err.println("Message: " + e.getMessage());
	                Throwable t = ex.getCause();
	                while (t != null) {
	                    System.out.println("Cause: " + t);
	                    t = t.getCause();
	                }
	            }
	        }
	    }
	    
	    public void deleteEmployee(int id) throws ClassNotFoundException {
	        String INSERT_USERS_SQL = "DELETE FROM employee_table WHERE employeeID = "+id;
	        Class.forName("com.mysql.cj.jdbc.Driver");

	        try (Connection connection = DriverManager
	            .getConnection(url,user,password);

	            // Step 2:Create a statement using connection object
	            PreparedStatement preparedStatement = connection.prepareStatement(INSERT_USERS_SQL)) {

	            System.out.println(preparedStatement);
	            
	            // Step 3: Execute the query or update query
	            preparedStatement.executeUpdate();

	        } catch (SQLException e) {
	            printSQLException(e);
	        }
	    }
	    
	    public Employee authenticate(String username, String upassword) throws ClassNotFoundException {
	        String LOGIN_SQL = "SELECT * FROM employee_table WHERE username = '"+username+"' AND password = '"+upassword+"'";
	        Employee employee = new Employee();
	        DTRModel dtrRecords = new DTRModel();

	        Class.forName("com.mysql.cj.jdbc.Driver");

	        try (Connection connection = DriverManager
	            .getConnection(url,user,password);
	        		
	            PreparedStatement preparedStatement = connection.prepareStatement(LOGIN_SQL)) {

	            System.out.println(preparedStatement);
	            
	            ResultSet result = preparedStatement.executeQuery();
	            
	            while(result.next()) {
	    	        dtrRecords.setDtrRecords(this.fetchDTRRecords(result.getInt("employeeID")));
	            	employee.setEmployeeID(result.getInt("employeeID"));
	            	employee.setFirstname(result.getString("firstname"));
	            	employee.setLastname(result.getString("lastname"));
	            	employee.setMi(result.getString("mi"));
	            	employee.setEmail(result.getString("email"));
	            	employee.setUsername(result.getString("username"));
	            	employee.setPassword(result.getString("password"));
	    	        employee.setDtrRecords(dtrRecords);
	            }
	            
	        } catch (SQLException e) {
	            printSQLException(e);
	        }
	        return employee;
	    }
	    
	    public ArrayList fetchDTRRecords(int employeeID) throws ClassNotFoundException {
	    	String FETCH_DTR_SQL = "SELECT * FROM dtr_table WHERE employeeID = "+employeeID;
	        ArrayList<HashMap<String,String>> records = new ArrayList<HashMap<String,String>>();
	        
	        Class.forName("com.mysql.cj.jdbc.Driver");
	        try (Connection connection = DriverManager
	            .getConnection(url,user,password);
	        		
	            PreparedStatement preparedStatement = connection.prepareStatement(FETCH_DTR_SQL)) {
	            System.out.println(preparedStatement);
	            ResultSet result = preparedStatement.executeQuery();
	            
	            while(result.next()) {
	    	        HashMap<String,String> record = new HashMap<String,String>();
	    	        record.put("date_in", result.getString("date_in"));
	    	        record.put("date_out", result.getString("date_out"));
	    	        records.add(record);
	            }
	            
	        } catch (SQLException e) {
	            printSQLException(e);
	        }
	        
	    	return records;
	    }
	    
	    public Employee recordTimeIn(String dateTime, int employeeID) throws ClassNotFoundException {
	    	String RECORD_TIME_IN_SQL = "INSERT INTO dtr_table(date_in, employeeID) VALUES ('"+dateTime+"', "+employeeID+")";
	    	Class.forName("com.mysql.cj.jdbc.Driver");

	        try (Connection connection = DriverManager
	            .getConnection(url,user,password);
	            PreparedStatement preparedStatement = connection.prepareStatement(RECORD_TIME_IN_SQL)) {
	            System.out.println(preparedStatement);
	            preparedStatement.executeUpdate();
	        } catch (SQLException e) {
	            printSQLException(e);
	        }
	        return null;
	    }
	    
	    public Employee recordTimeOut(String dateTime, int employeeID) throws ClassNotFoundException {
	    	String RECORD_TIME_OUT_SQL = "UPDATE dtr_table SET date_out = '"+dateTime+"' WHERE id = (select * from (select max(id) from dtr_table where employeeID = "+employeeID+" AND date_out IS NULL) as t)";
	    	try (Connection connection = DriverManager
		            .getConnection(url,user,password);
	            PreparedStatement preparedStatement = connection.prepareStatement(RECORD_TIME_OUT_SQL)) {
	            System.out.println(preparedStatement);
	            preparedStatement.executeUpdate();
	        } catch (SQLException e) {
	            printSQLException(e);
	        }
	        return null;
	    }
}
